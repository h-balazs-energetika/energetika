<!DOCTYPE html>
<html lang="hu" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gázárajánlat Kiértékelő - Nagyatád Város Önkormányzata</title>
    <!-- Font and Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-main: #0a0c10;
            --bg-card: #151921;
            --primary: #5c6bc0;
            --secondary: #26a69a;
            --accent: #7b61ff;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border-color: #2d3748;
            --danger: #ef5350;
            --warning: #ffb74d;
            --success: #4caf50;
        }

        [data-theme="dark"] {
            color-scheme: dark;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            line-height: 1.6;
            padding-bottom: 4rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #1a237e 0%, #0a0c10 100%);
            padding: 3rem 2rem;
            border-radius: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(123, 97, 255, 0.15) 0%, transparent 70%);
            z-index: 1;
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        header h1 {
            font-family: 'Outfit';
            font-size: 2.2rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        header .subtitle {
            color: var(--text-muted);
            font-weight: 500;
            font-size: 1.1rem;
        }

        /* Toggle Button */
        .unit-toggle {
            position: relative;
            z-index: 10;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 2rem;
            display: flex;
            gap: 0.25rem;
            backdrop-filter: blur(10px);
        }

        .unit-btn {
            padding: 0.5rem 1.25rem;
            border-radius: 1.5rem;
            font-size: 0.85rem;
            font-weight: 800;
            cursor: pointer;
            border: none;
            color: var(--text-muted);
            background: transparent;
            transition: all 0.2s;
        }

        .unit-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px rgba(123, 97, 255, 0.4);
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
        }

        @media (max-width: 1100px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
            padding: 1.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            margin-bottom: 2rem;
        }

        .card-title {
            font-family: 'Outfit';
            font-size: 1.25rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--primary);
        }

        /* Inputs */
        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input[type="number"],
        input[type="range"] {
            width: 100%;
            background: #0f1218;
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            color: white;
            font-size: 1rem;
            font-weight: 600;
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(123, 97, 255, 0.2);
        }

        .slider-wrap {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .slider-wrap span {
            min-width: 60px;
            font-weight: 800;
            color: var(--accent);
        }

        /* Comparison Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 900;
            display: block;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Summary Bar */
        .summary-banner {
            grid-column: 1 / -1;
            padding: 1.5rem;
            border-radius: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            font-weight: 800;
        }

        .winner-fix {
            background: rgba(38, 166, 154, 0.1);
            border: 1px solid var(--secondary);
            color: var(--secondary);
        }

        .winner-indexed {
            background: rgba(123, 97, 255, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            padding: 0.75rem;
            text-align: left;
            font-size: 0.85rem;
            border-bottom: 1px solid #1e2530;
        }

        th {
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
        }

        .highlight-row {
            background: rgba(92, 107, 192, 0.05);
        }

        /* Analysis Sections */
        .alert-box {
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .alert-warning {
            background: rgba(255, 183, 77, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .alert-danger {
            background: rgba(239, 83, 80, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .chart-container {
            height: 350px;
            position: relative;
            margin-top: 1rem;
        }

        .risk-list {
            list-style: none;
            margin-top: 1rem;
        }

        .risk-item {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .risk-item i {
            margin-top: 0.25rem;
        }

        .tag {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 800;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .tag-info {
            background: rgba(92, 107, 192, 0.2);
            color: var(--primary);
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <div class="header-content">
                <h1>Gázenergia Ajánlat-elemző</h1>
                <p class="subtitle">Nagyatád Város Önkormányzata • Irodai Döntéstámogató Rendszer</p>
            </div>
            <div class="unit-toggle">
                <button id="btnKWh" class="unit-btn active" onclick="setUnit('kWh')">Ft/kWh</button>
                <button id="btnMJ" class="unit-btn" onclick="setUnit('MJ')">Ft/MJ</button>
            </div>
        </header>

        <!-- Részletes Szerződési Kockázatelemzés -->
        <div class="card" style="margin-bottom: 2rem; border-top: 4px solid var(--danger);">
            <h3 class="card-title" style="color: var(--danger); font-size: 1.6rem; margin-bottom: 2rem;">
                <i class="fas fa-exclamation-circle"></i> Részletes Szerződési Kockázatelemzés (Fogyasztói Oldal)
            </h3>
            <div class="analysis-content">
                <p style="margin-bottom: 1.25rem;"><strong>1. Ráutaló magatartással történő szerződéskötés:</strong> A
                    dokumentum egyik legveszélyesebb pontja, hogy az ajánlat elutasításának hiánya (hallgatás)
                    automatikusan a szerződés létrejöttét eredményezi. A fogyasztónak mindössze 15 napja van az írásbeli
                    elutasításra, különben a hűségidővel terhelt új feltételek érvénybe lépnek.</p>
                <p style="margin-bottom: 1.25rem;"><strong>2. Hosszú távú, 3 éves elköteleződés:</strong> Az ajánlat
                    2026. október 1-től 2029. október 1-ig tartó hűségidőszakot ír elő. Ez a három éves kötöttség
                    rendkívül hosszú idő a jelenlegi instabil geopolitikai és energiapiaci helyzetben, jelentősen
                    korlátozva az önkormányzat mozgásterét.</p>
                <p style="margin-bottom: 1.25rem;"><strong>3. Indexált árazás piaci volatilitása:</strong> A tőzsdei
                    (VTP) árazás közvetlenül kitettséget jelent a piaci kilengéseknek. Míg a csökkenő trend előnyös, egy
                    hirtelen gázpiaci sokk (háború, vezetékleállás) azonnali és drasztikus költségnövekedést okoz a fix
                    díjas konstrukciókkal szemben.</p>
                <p style="margin-bottom: 1.25rem;"><strong>4. EUR/HUF devizakockázat:</strong> Mivel az elszámolás
                    alapja EUR/MWh, a számlázás viszont forintban történik, az önkormányzat teljes mértékben viseli a
                    forint gyengülésének kockázatát. Egy tartós árfolyamromlás önmagában, a piaci gázár változása nélkül
                    is jelentősen drágíthatja az energiát.</p>
                <p style="margin-bottom: 1.25rem;"><strong>5. Kereskedői egyoldalú árrögzítési jog:</strong> A szerződés
                    2.2-es pontja felhatalmazza az eladót, hogy egyoldalúan rögzítse az árat (maximum 50 EUR/MWh
                    szintig). Ez azt jelenti, hogy a kereskedő akkor "fagyaszthatja be" az árat, amikor az neki kedvező,
                    elvéve a fogyasztótól a további piaci árcsökkenés előnyét.</p>
                <p style="margin-bottom: 1.25rem;"><strong>6. Felmondási jog kizárása árrögzítéskor:</strong> Különösen
                    hátrányos a 2.4-es pont, amely kimondja, hogy ha a kereskedő él az egyoldalú árrögzítési jogával, a
                    fogyasztó nem jogosult a szerződés felmondására. Ez lényegében csapdába ejti a vevőt egy fixált, de
                    esetleg piaci feletti árfolyamon.</p>
                <p style="margin-bottom: 1.25rem;"><strong>7. Az "utolsó ajánlattételi jog" versenytorzító
                        hatása:</strong> A 2.12-es pont kötelezi az önkormányzatot, hogy a szerződés lejárta után is
                    megmutassa a legjobb versenytársi ajánlatát az E2-nek. Ez elriasztja a többi kereskedőt a valódi
                    versenyzéstől, hiszen tudják, hogy az inkumbens szolgáltató bármikor ráígérhet az ajánlatukra.</p>
                <p style="margin-bottom: 1.25rem;"><strong>8. Súlyos pótdíjak alkalmazása:</strong> Amennyiben a
                    fogyasztó nem biztosítja az utolsó ajánlattételi jogot, 500.000 Ft-os, vagy akár ennél is magasabb
                    pótdíj megfizetésére kötelezhető. Ez az összeg többszörösen is kivethető, ami jelentős pénzügyi
                    fenyegetést jelent.</p>
                <p style="margin-bottom: 1.25rem;"><strong>9. Rendkívül szűk felmondási ablak:</strong> A szerződés
                    rendes felmondása csak a gázév fordulója előtt, a 210. és 180. nap közötti szűk, 30 napos
                    intervallumban lehetséges. Aki elvéti ezt az időpontot, az automatikusan bent marad a rendszerben a
                    következő időszakra is.</p>
                <p style="margin-bottom: 1.25rem;"><strong>10. Automatikus meghosszabbodás kockázata:</strong> A
                    felmondás elmaradása esetén a szerződés határozatlan idejűvé válik, de a kereskedőnek továbbra is
                    joga marad az árközlésre, amivel szemben a fogyasztó védtelen marad, ha nem figyel a határidőkre.
                </p>
                <p style="margin-bottom: 1.25rem;"><strong>11. ÁSZF egyoldalú módosíthatósága:</strong> A szerződés
                    hivatkozik a kereskedő Üzletszabályzatára és ÁSZF-ére, amelyeket a szolgáltató egyoldalúan
                    módosíthat. Bár elvileg van felmondási jog módosításkor, a folyamat bonyolultsága miatt a fogyasztók
                    ritkán élnek ezzel.</p>
                <p style="margin-bottom: 1.25rem;"><strong>12. Rejtett és áthárítható költségek:</strong> A 2.5-ös pont
                    szerint a kereskedő jogosult minden olyan extra adót, díjat vagy költséget áthárítani, "amely
                    máshonnan nem térülne meg számára". Ez egy biankó felhatalmazás a jövőbeni szabályozói változások
                    költségeinek fogyasztóra terhelésére.</p>
                <p style="margin-bottom: 1.25rem;"><strong>13. Kapacitástúllépési többletköltségek:</strong> A 130%-ot
                    meghaladó havi fogyasztás esetén a vevőnek extra rendszerhasználati díjakat kell fizetnie. Ez a
                    rugalmatlanság bünteti az önkormányzatot, ha például egy hidegebb tél miatt a tervezettnél több gázt
                    kényszerül használni.</p>
                <p style="margin-bottom: 1.25rem;"><strong>14. Ügyfélminősítés és előrefizetési kényszer:</strong> A
                    kereskedő fenntartja a jogot, hogy bármikor egyoldalúan negatívan minősítse az ügyfelet, és
                    biztosíték nyújtását vagy előrefizetést követeljen. Ez likviditási válságot okozhat az önkormányzati
                    gazdálkodásban.</p>
                <p style="margin-bottom: 1.25rem;"><strong>15. Feltűnő értékaránytalanság kizárása:</strong> A 11.18-as
                    pontban a felek előre lemondanak arról, hogy a szerződést feltűnő értékaránytalanság (túlzottan
                    drága ár) miatt megtámadják. Ez egy fontos jogi védelmi vonalat vesz el a fogyasztótól.</p>
                <p style="margin-bottom: 1.25rem;"><strong>16. Bonyolult árképzési mechanizmus:</strong> A VTP Day-Ahead
                    Index és a Heren Árak napi súlyozott átlaga olyan komplex számítást igényel, amelyet egy átlagos
                    irodai alkalmazott képtelen ellenőrizni. Emiatt a fogyasztó kénytelen vakon bízni a kereskedő
                    számlázásának helyességében.</p>
                <p style="margin-bottom: 1.25rem;"><strong>17. Extrém piaci környezet szabályai:</strong> A szerződés
                    hivatkozik az extrém árkörnyezet esetén irányadó, rendkívüli elszámolási szabályokra. Ezek a
                    szabályok általában a kereskedő veszteségeinek minimalizálását szolgálják a fogyasztó kárára
                    válsághelyzetben.</p>
                <p style="margin-bottom: 1.25rem;"><strong>18. A nominálás felelőssége:</strong> Bár alapértelmezésben
                    az eladó nominál, az esetleges pontatlan adatszolgáltatásból vagy kapacitásmódosításból eredő
                    pótdíjakat végül a vevőre háríthatják át különféle jogcímeken.</p>
                <p style="margin-bottom: 1.25rem;"><strong>19. Adatkezelési és kártalanítási felelősség:</strong> Az
                    adatvédelmi felelősség (GDPR) áthárítása és az ezzel kapcsolatos bírságok teljes mértékű
                    továbbhárítása a fogyasztóra szintén olyan pont, ami egy egyszerű közüzemi szerződéshez képest
                    aránytalan terhet róhat a vevőre.</p>
                <p style="margin-bottom: 1.25rem;"><strong>20. Összegzés és kritikus javaslat:</strong> A
                    szerződéstervezet rendkívül aszimmetrikus, a kockázatok nagy részét a fogyasztóra hárítja, miközben
                    a kereskedőnek számos egyoldalú beavatkozási lehetőséget biztosít. Javasolt a 15 napos határidőn
                    belüli hivatalos elutasítás és egy kedvezőbb, tárgyalásos alapú feltételrendszer kérése.</p>
            </div>
        </div>


        <div class="dashboard-grid">
            <!-- Control Side -->
            <div class="control-panel">
                <div class="card">
                    <h3 class="card-title text-primary"><i class="fas fa-sliders-h"></i> Paraméterek</h3>

                    <div class="input-group">
                        <label>Éves fogyasztás (<span class="unit-label">kWh</span>)</label>
                        <input type="number" id="annualIn" value="400000" min="0" oninput="calculate()">
                        <div style="font-size:0.7rem; color:var(--text-muted); margin-top:4px;">kB. <span
                                id="secEquivalent">0</span> <span id="secUnit">m3</span></div>
                    </div>

                    <div class="input-group">
                        <label>Fix díjas alapár (Ft/<span class="unit-label">kWh</span>)</label>
                        <input type="number" id="fixPriceIn" value="23.5" step="0.1" oninput="calculate()">
                        <div style="font-size:0.7rem; color:var(--text-muted); margin-top:4px;">Jelenlegi érvényes
                            szerződés</div>
                    </div>

                    <div class="input-group">
                        <label>Kereskedői árrés (EUR/MWh)</label>
                        <input type="number" id="traderMargin" value="20.0" step="0.5" oninput="calculate()">
                        <div style="font-size:0.7rem; color:var(--text-muted); margin-top:4px;">Az indexált ajánlat
                            felára</div>
                    </div>

                    <div class="input-group">
                        <label>EUR/HUF Árfolyam</label>
                        <div class="slider-wrap">
                            <input type="range" id="eurRateRange" min="300" max="500" value="390"
                                oninput="document.getElementById('eurRateVal').innerText = this.value; calculate()">
                            <span id="eurRateVal">390</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Piaci várakozás (Tőzsdei ár +/- %)</label>
                        <div class="slider-wrap">
                            <input type="range" id="marketShift" min="-30" max="50" value="0"
                                oninput="document.getElementById('marketShiftVal').innerText = (this.value > 0 ? '+' : '') + this.value + '%'; calculate()">
                            <span id="marketShiftVal">0%</span>
                        </div>
                        <div style="font-size:0.65rem; color:var(--text-muted); margin-top:4px;">Kockázati szimuláció a
                            2025-ös bázishoz képest</div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title" style="color:var(--accent);"><i class="fas fa-microchip"></i> Gyorsadatok
                    </h3>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <span class="stat-label">Fix Költség</span>
                            <span class="stat-value" id="totalFixPrice">0</span>
                            <span class="stat-label">ezer Ft / év</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Indexált Várható</span>
                            <span class="stat-value" id="totalIndexedPrice">0</span>
                            <span class="stat-label">ezer Ft / év</span>
                        </div>
                    </div>
                    <div id="savingsResult" class="summary-banner winner-indexed" style="display: none;">
                        <span>Várható megtakarítás:</span>
                        <span id="savingsValue">0 Ft</span>
                    </div>
                </div>
            </div>

            <!-- Main Display Side -->
            <div class="main-panel">
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-chart-line"></i> Költség-vetület (<span class="unit-label">Ft/kWh</span>)
                        <span class="tag tag-info">Bázis: 2025 várható havi árak</span>
                    </h3>
                    <div class="chart-container">
                        <canvas id="compChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title"><i class="fas fa-clipboard-check"></i> Részletes Havi Elemzés</h3>
                    <div style="overflow-x: auto;">
                        <table id="detailsTable">
                            <thead>
                                <tr>
                                    <th>Hónap</th>
                                    <th>HUDEX (EUR/MWh)</th>
                                    <th>Fix ár (<span class="unit-label">Ft/kWh</span>)</th>
                                    <th>Indexált ár (<span class="unit-label">Ft/kWh</span>)</th>
                                    <th>Különbözet (Ft)</th>
                                    <th>Státusz</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Historical Section -->
                <div class="card">
                    <h3 class="card-title" style="color:var(--secondary);"><i class="fas fa-history"></i> Történelmi
                        Visszatekintés (CEEGEX adatok)</h3>
                    <div style="font-size:0.9rem; color:var(--text-muted); margin-bottom:1rem;">
                        Az alábbi táblázat azt mutatja, hogyan teljesített volna a piac a korábbi években a jelenlegi
                        <strong><span id="histFixVal">23.5</span> <span class="unit-label">Ft/kWh</span></strong>-s fix
                        árhoz képest.
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="histTable">
                            <thead>
                                <tr>
                                    <th>Év</th>
                                    <th>Piac (EUR/MWh)</th>
                                    <th>Piac (<span class="unit-label">Ft/kWh</span>)</th>
                                    <th>Fix ár (<span class="unit-label">Ft/kWh</span>)</th>
                                    <th>Különbség (Ft)</th>
                                </tr>
                            </thead>
                            <tbody id="historicalTableBody">
                                <!-- JS fills this -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title" style="color:var(--warning);"><i class="fas fa-shield-alt"></i> Szakmai
                        Kiértékelés & Kockázatok</h3>
                    <div id="riskAnalysis">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script>
        // 2025 HUDEX Baseline EUR/MWh
        const hudex2025 = [32, 33.5, 31, 29.5, 30.2, 32.8, 34.1, 35.5, 34.8, 36.2, 38.5, 39.1];
        const months = ['Jan', 'Feb', 'Már', 'Ápr', 'Máj', 'Jún', 'Júl', 'Aug', 'Szept', 'Okt', 'Nov', 'Dec'];

        // Historical CEEGEX data (Price in Ft/MJ)
        const historicalData = [
            { year: 2024, eurMwh: 34.34, ftMj: 3.82 },
            { year: 2023, eurMwh: 41.51, ftMj: 4.61 },
            { year: 2022, eurMwh: 121.75, ftMj: 13.53 },
            { year: 2021, eurMwh: 45.42, ftMj: 5.05 },
            { year: 2020, eurMwh: 10.15, ftMj: 1.13 }
        ];

        let currentUnit = 'kWh'; // 'kWh' or 'MJ'
        let chartObj = null;

        function formatNumber(num) {
            return new Intl.NumberFormat('hu-HU').format(Math.round(num));
        }

        function setUnit(unit) {
            if (currentUnit === unit) return;

            const oldUnit = currentUnit;
            currentUnit = unit;

            // Update UI buttons
            document.getElementById('btnKWh').classList.toggle('active', unit === 'kWh');
            document.getElementById('btnMJ').classList.toggle('active', unit === 'MJ');

            // Update labels
            document.querySelectorAll('.unit-label').forEach(el => el.innerText = unit);

            // Convert input values
            const annualIn = document.getElementById('annualIn');
            const fixPriceIn = document.getElementById('fixPriceIn');

            if (unit === 'MJ') {
                annualIn.value = (parseFloat(annualIn.value) * 3.6).toFixed(0);
                fixPriceIn.value = (parseFloat(fixPriceIn.value) / 3.6).toFixed(2);
            } else {
                annualIn.value = (parseFloat(annualIn.value) / 3.6).toFixed(0);
                fixPriceIn.value = (parseFloat(fixPriceIn.value) * 3.6).toFixed(1);
            }

            calculate();
        }

        function calculate() {
            const annualIn = parseFloat(document.getElementById('annualIn').value) || 0;
            const fixPriceIn = parseFloat(document.getElementById('fixPriceIn').value) || 0;
            const marginEUR = parseFloat(document.getElementById('traderMargin').value) || 0;
            const eurRate = parseFloat(document.getElementById('eurRateRange').value);
            const shiftFactor = 1 + (parseFloat(document.getElementById('marketShift').value) / 100);

            let annualKWh, fixPriceKWh;

            if (currentUnit === 'MJ') {
                annualKWh = annualIn / 3.6;
                fixPriceKWh = fixPriceIn * 3.6;
                document.getElementById('secEquivalent').innerText = formatNumber(annualIn / 10.5 / 3.6);
                document.getElementById('secUnit').innerText = 'm3';
            } else {
                annualKWh = annualIn;
                fixPriceKWh = fixPriceIn;
                document.getElementById('secEquivalent').innerText = formatNumber(annualIn / 10.5);
                document.getElementById('secUnit').innerText = 'm3';
            }

            const totalKWh = annualKWh;
            const monthlyKWh = totalKWh / 12;

            let totalFixCost = totalKWh * fixPriceKWh;
            let totalIndexedCost = 0;

            const displayIndexedRates = [];
            const tableBody = document.querySelector('#detailsTable tbody');
            tableBody.innerHTML = '';

            hudex2025.forEach((baseEUR, i) => {
                const adjustedBase = baseEUR * shiftFactor;
                const indexedRateKWh = ((adjustedBase + marginEUR) * eurRate) / 1000;
                const monthlyCost = monthlyKWh * indexedRateKWh;
                totalIndexedCost += monthlyCost;

                const displayRate = currentUnit === 'MJ' ? (indexedRateKWh / 3.6).toFixed(2) : indexedRateKWh.toFixed(2);
                displayIndexedRates.push(displayRate);

                const displayFix = fixPriceIn.toFixed(currentUnit === 'MJ' ? 2 : 1);
                const diff = fixPriceIn - parseFloat(displayRate);
                const statusIcon = diff > 0 ? '<i class="fas fa-check-circle text-success"></i>' : '<i class="fas fa-exclamation-triangle text-danger"></i>';
                const diffClass = diff > 0 ? 'text-success' : 'text-danger';

                const row = tableBody.insertRow();
                row.innerHTML = `
                <td>${months[i]}</td>
                <td>${adjustedBase.toFixed(1)}</td>
                <td style="font-weight:600;">${displayFix}</td>
                <td style="font-weight:700; color:var(--accent);">${displayRate}</td>
                <td class="${diffClass}" style="font-weight:bold;">${(Math.abs(diff)).toFixed(2)}</td>
                <td style="text-align:center;">${statusIcon}</td>
            `;
            });

            // Update Stats
            document.getElementById('totalFixPrice').innerText = formatNumber(totalFixCost / 1000);
            document.getElementById('totalIndexedPrice').innerText = formatNumber(totalIndexedCost / 1000);
            document.getElementById('histFixVal').innerText = fixPriceIn.toFixed(currentUnit === 'MJ' ? 2 : 1);

            const savings = totalFixCost - totalIndexedCost;
            const savingsEl = document.getElementById('savingsResult');
            const savingsVal = document.getElementById('savingsValue');

            savingsEl.style.display = 'flex';
            if (savings > 0) {
                savingsEl.className = 'summary-banner winner-indexed';
                savingsVal.innerText = formatNumber(savings) + " Ft megtakarítás";
            } else {
                savingsEl.className = 'summary-banner alert-danger';
                savingsVal.innerText = formatNumber(Math.abs(savings)) + " Ft veszteség";
            }

            updateRiskAnalysis(savings, fixPriceKWh, displayIndexedRates, eurRate, fixPriceIn);
            updateChart(displayIndexedRates, fixPriceIn);
            updateHistorical(fixPriceIn);
        }

        function updateHistorical(currentFixIn) {
            const hBody = document.getElementById('historicalTableBody');
            hBody.innerHTML = '';

            historicalData.forEach(d => {
                const histValIn = currentUnit === 'MJ' ? d.ftMj : d.ftMj * 3.6;
                const diff = currentFixIn - histValIn;
                const row = hBody.insertRow();
                const colorClass = diff > 0 ? 'text-success' : 'text-danger';

                row.innerHTML = `
                <td style="font-weight:700;">${d.year}</td>
                <td>${d.eurMwh.toFixed(2)}</td>
                <td style="font-weight:700; color:var(--accent);">${histValIn.toFixed(2)}</td>
                <td>${currentFixIn.toFixed(currentUnit === 'MJ' ? 2 : 1)}</td>
                <td class="${colorClass}" style="font-weight:bold;">${diff > 0 ? 'ELŐNY: ' : 'HÁTRÁNY: '}${Math.abs(diff).toFixed(2)} Ft</td>
            `;
            });
        }

        function updateRiskAnalysis(savings, fixPriceKWh, indexedRates, eurRate, fixPriceIn) {
            const riskEl = document.getElementById('riskAnalysis');
            let html = '';

            const avgIndexed = indexedRates.reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 12;

            if (savings > 0) {
                html += `
                <div class="alert-box alert-success">
                    <i class="fas fa-check-double fa-2x"></i>
                    <div>
                        <strong>Javaslat: Átállás Indexáltra ajánlott.</strong> 
                        A modell alapján az éves megtakarítás eléri a <strong>${formatNumber(savings)} Ft</strong>-ot. 
                        Az átlagos egységár (${avgIndexed.toFixed(2)} Ft/${currentUnit}) 10-15%-kal a jelenlegi fix ár alatt marad.
                    </div>
                </div>
            `;
            } else {
                html += `
                <div class="alert-box alert-danger">
                    <i class="fas fa-hand-paper fa-2x"></i>
                    <div>
                        <strong>Javaslat: Maradás a FIX díjas szerződésben.</strong> 
                        A jelenlegi piaci viszonyok mellett az indexált ár átlagosan ${Math.abs(avgIndexed - fixPriceIn).toFixed(2)} Ft-tal magasabb a fix díjnál.
                    </div>
                </div>
            `;
            }

            html += '<p style="margin-top:1.5rem; font-weight:700; color:var(--text-main);"><i class="fas fa-exclamation-triangle text-warning"></i> Kritikus kockázati tényezők:</p>';
            html += '<ul class="risk-list">';
            html += `<li class="risk-item"><i class="fas fa-money-bill-wave text-warning"></i> <span><strong>Valutakockázat:</strong> Az EUR/HUF árfolyam minden 5 Ft-os romlása kB. ${currentUnit === 'MJ' ? '0.14' : '0.5'} Ft-tal drágítja az indexált energiát.</span></li>`;
            html += `<li class="risk-item"><i class="fas fa-globe-europe text-primary"></i> <span><strong>Geopolitika:</strong> Az indexált ár azonnal leköveti a gázpiaci sokkokat, míg a fix ár pufferként szolgál.</span></li>`;
            html += `<li class="risk-item"><i class="fas fa-balance-scale text-secondary"></i> <span><strong>Likviditás:</strong> Az indexált számlázás változó havi költségei nehezítik az önkormányzati cash-flow tervezést.</span></li>`;
            html += '</ul>';

            riskEl.innerHTML = html;
        }

        function updateChart(indexedData, fixValue) {
            const ctx = document.getElementById('compChart').getContext('2d');
            const fixData = Array(12).fill(fixValue);

            if (chartObj) {
                chartObj.data.datasets[0].data = indexedData;
                chartObj.data.datasets[0].label = `Indexált ár (Ft/${currentUnit})`;
                chartObj.data.datasets[1].data = fixData;
                chartObj.data.datasets[1].label = `Fix ár (Ft/${currentUnit})`;
                chartObj.options.scales.y.title.text = `Ft/${currentUnit}`;
                chartObj.update();
            } else {
                chartObj = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: `Indexált ár (Ft/${currentUnit})`,
                                data: indexedData,
                                borderColor: '#7b61ff',
                                backgroundColor: 'rgba(123, 97, 255, 0.1)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3
                            },
                            {
                                label: `Fix ár (Ft/${currentUnit})`,
                                data: fixData,
                                borderColor: '#ffffff',
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#94a3b8', font: { weight: 'bold' } } },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label + ': ' + context.parsed.y + ' Ft/' + currentUnit;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#94a3b8' },
                                title: { display: true, text: 'Ft/' + currentUnit, color: '#94a3b8' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#94a3b8' }
                            }
                        }
                    }
                });
            }
        }

        calculate();
    </script>

</body>

</html>